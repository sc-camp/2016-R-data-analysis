{
    "contents" : "# Luc Bussi√®re\n# Stats Practical Exercise on predict()\n# April 20, 2015\n\n# last modified Nov 29, 2015\n\n# This is a practical exercise for the AdvInR course\n# featuring tips and tricks for making predictions from \n# linear model coefficients\n\n# clear R of all objects\nrm(list=ls())\n\n# concept quiz: how well can you interpret coefficients?\n\n# See the last page of the practical handout for a candidate answer to the challenge\n\n# Using broom dplyr, and ggplot to get fitted lines\n############################\n\nlibrary(broom)\nlibrary(dplyr)\nlibrary(ggplot2)\n\n##\n# First use the data for simple linear regression\n##\n# import tannin data from Module 3 (linear models)\nTANDAT <- read.csv(\"tannin.csv\")\n\ntanfit <- lm(GROWTH ~ TANNIN,\n             data = TANDAT)\n\nsummary(tanfit)\n\n## Get a 'tidy' version of the model coefficients\ntidy(tanfit)\n\n## We can send the tidied model coefficients to a CSV file, so that the coefficients are easier to import into tables in MS Word or Excel\nwrite.csv(tidy(tanfit), \"TanninFits.csv\", row.names = FALSE)\n\n## Get a 'tidy' version of the model summary statistics\nglance(tanfit)\n\n## 'Augment' adds columns to the original data set\naugment(tanfit)\n\n## This includes predicted values etc, meaning we can \n#   work up a fancy figure very easily by chaining functions...\ntanfit %>%\n  augment() %>%\n  ggplot(data = .,\n         aes(x = TANNIN,\n             y = GROWTH)) +\n  geom_point() +                  # points from original data frame\n  geom_line(aes(y = .fitted)) +   # line from model fit\n  geom_ribbon(aes(ymin = .fitted - (2 * .se.fit),\n                  ymax = .fitted + (2 * .se.fit)),   # CIs from model fit\n              alpha = 0.3) +\n  theme_bw()\n\n## You can even chain the whole thing, including linear model (although of course you should not be visualizing models before examining diagnostics)\nTANDAT %>%\n  lm(GROWTH ~ TANNIN, data = .) %>%\n  augment() %>%\n  ggplot(data = .,\n         aes(x = TANNIN,\n             y = GROWTH)) +\n  geom_point() +\n  geom_line(aes(y = .fitted)) +\n  geom_ribbon(aes(ymin = .fitted - (2 * .se.fit),\n                  ymax = .fitted + (2 * .se.fit)),\n              alpha = 0.3) +\n  theme_bw()\n\n\n# alternatively, can use the package visreg\nlibrary(visreg)\n# basic plot\nvisreg(tanfit)                          \n# with points options\nvisreg(tanfit, points.par = list(cex = 1.2, col = \"red\"))\n# with labels adjusted\nvisreg(tanfit,points.par = list(cex = 1.2, col = \"red\"),\n       ylab=\"Caterpillar mass gain (g)\",\n       xlab=\"Dietary tannin dose (g/kg)\") \n\n       \n\n###### Broom with ANCOVA ######\n\nCOMP <- read.csv(\"compensationo.csv\")\n\ncomp_mod <- lm(FRUIT ~ ROOT + GRAZING,\n               data = COMP)\n\nsummary(comp_mod)\n\n##\n# How do the tidy versions change when there are multiple variables\n##\n\n\n## Get a 'tidy' version of the model coefficients\ntidy(comp_mod)\n\n## Get a 'tidy' version of the model summary statistics\nglance(comp_mod)\n\n## 'Augment' adds columns to the original data set\naugment(comp_mod)\n\n##\n# You will notice that we get predicted values (.fitted) for \n#  FRUIT against ROOT for each level of GRAZING.\n#\n# We can use these to plot our predictions as before...\n##\ncomp_mod %>%\n  augment() %>%\n  ggplot(data = .,\n         aes(x = ROOT,\n             y = FRUIT,\n             colour = GRAZING,\n             fill = GRAZING)) +\n  geom_point() +                  # points from original data frame\n  geom_line(aes(y = .fitted)) +   # line from model fit\n  geom_ribbon(aes(ymin = .fitted - (1.96 * .se.fit),\n                  ymax = .fitted + (1.96 * .se.fit)),   # CIs from model fit\n              alpha = 0.3,\n              linetype = 0) +\n  theme_bw()\n\n\n# Using visreg\n# When you plot just one of the variables, visreg adjusts the data points for the other factors, conditioning on the most common factor level (for categorical factors) or the median value (for numeric variables). If you plot more than one variable, you can choose to overlay the fits for the different levels of the factor, or you can plot in separate panels.\n\n# basic plots, will need to interact with console to see both\nvisreg(comp_mod)\n\n\n# stripchart for GRAZING, holding ROOT constant (at mean)\nvisreg(comp_mod, xvar = \"GRAZING\", whitespace = 0.4, \n       points.par = list(cex = 1.1, col = \"red\"))\n\n# can change the conditioning values;\n# notice how when we change the ROOT diameter we change the location of the expected means for each treatment\nvisreg(comp_mod, xvar = \"GRAZING\", whitespace = 0.4, \n       points.par = list(cex = 1.1, col = \"red\"),\n       cond=list(ROOT=10))\n\n# when using visreg to plot continuous variable effects in models with balanced designs, it's useful to check which treatment visreg by changing the condition statement\n\n# First, plot only the effect of ROOT, but it's not clear which treatment for GRAZING is being used\nvisreg(comp_mod, xvar = \"ROOT\",\n       points.par = list(cex = 1.1, col = \"red\"))\n\n# Now systematically change conditioning argument\nvisreg(comp_mod, xvar = \"ROOT\",\n       points.par = list(cex = 1.1, col = \"red\"),\n       cond=list(GRAZING=\"Ungrazed\"))\nvisreg(comp_mod, xvar = \"ROOT\",\n       points.par = list(cex = 1.1, col = \"red\"),\n       cond=list(GRAZING=\"Grazed\"))\n# The second option matches the default\n\n# using panels (I think this is not so clear)\nvisreg(comp_mod, xvar = \"ROOT\", by = \"GRAZING\", \n       points.par = list(cex = 1.1, col = \"red\"))\n\n# overlay\nvisreg(comp_mod, xvar = \"ROOT\", by = \"GRAZING\",\n       overlay = TRUE, band = TRUE, points.par = list(cex = 1.1))\n\n\n\n# now supp exercises from ANCOVA\n# import data from suppex for ANCOVA on cattle weight gain\nWEIGHTS<-read.csv(\"growth.csv\")\nhead(WEIGHTS)\n\n# relevel supplement so that control is reference\nWEIGHTS$SUPPLEMENT<-relevel(WEIGHTS$SUPPLEMENT,ref=\"control\")\n\n# build a model\nMOD.WEIGHTS<-lm(GAIN~DIET*SUPPLEMENT,data=WEIGHTS)\n\n# stripcharts for ANOVA\n# basic plots, will need to interact with console to see both\nvisreg(MOD.WEIGHTS)       \n\n# only one variable visualized\nvisreg(MOD.WEIGHTS, xvar = \"DIET\", whitespace = 0.4, \n       points.par = list(cex = 1.1, col = \"red\"))\n\n# three panels for diet\nvisreg(MOD.WEIGHTS, xvar = \"SUPPLEMENT\", by = \"DIET\", \n       whitespace = 0.4, points.par = list(cex = 1.1, col = \"red\"))\n\n# overlay (but no 95%CI)\nvisreg(MOD.WEIGHTS, xvar = \"SUPPLEMENT\", by = \"DIET\",\n       whitespace = 0.5, overlay = TRUE, band = FALSE, \n       points.par = list(cex = 1.1))\n\n\n# generalized models?\n\nISLAND<-read.csv(\"isolation.csv\")\nnames(ISLAND)\nMOD.2<-glm(INCIDENCE~AREA+ISOLATION,data=ISLAND,binomial)\n\n# visreg will visualize fit on the transformed scale\nvisreg(MOD.2, xvar = \"ISOLATION\")\nvisreg(MOD.2, xvar = \"AREA\")\n\n# or on the original scale; note \"rug\" which shows the position of data\nvisreg(MOD.2, xvar = \"ISOLATION\",scale=\"response\",rug=2,ylab=\"Incidence probability\",xlab=\"Isolation from mainland (km)\")\nvisreg(MOD.2, xvar = \"AREA\",scale=\"response\",rug=2,ylab=\"Incidence probability\",xlab=\"Island area (km^2)\")\n\n\n# OK, now plotting interactions between continuous variables\n# import data on attractiveness of male dance fly silhouettes\n\nDF <- read.csv(\"FLYSEX.csv\")\nstr(DF)\n# quality control\nhist(DF$LEG)\nhist(DF$ABDOMEN)\nhist(DF$ATTR)\n# def poisson\n\n# simple bivar plots\nplot(ATTR~LEG,data=DF)\nplot(ATTR~ABDOMEN,data=DF)\n\n# prelim look at combined effects\nggplot(DF, aes(x = LEG,\n                     y = ABDOMEN,\n                     colour = ATTR)) +\n  geom_jitter(alpha = 0.8,\n              size = 3)\n\n\nhead(DF)\nORN.MOD<-glm(ATTR~LEG*ABDOMEN,data=DF,family=poisson)\nsummary(ORN.MOD)\n# underdispersion\n\nlibrary(boot)\nglm.diag.plots(ORN.MOD)\n# model fit obviously not great; homogeneity of variance not met\n# let's ignore for the purpose of this exercise'\n\nORN.MOD.Q<-glm(ATTR~LEG*ABDOMEN,data=DF,family=quasipoisson)\nsummary(ORN.MOD.Q)\n\n# simplify model?\nORN.MOD.Q2<-update(ORN.MOD.Q, ~. -LEG:ABDOMEN)\nanova(ORN.MOD.Q,ORN.MOD.Q2,test=\"Chi\")\n\n# must retain interaction\n\n# Using visreg, can plot interactions by specifying \"breaks\", which are levels of other predictor to use in plot\n\nvisreg(ORN.MOD.Q,xvar=\"LEG\",by=\"ABDOMEN\",breaks=c(-2,0,2),scale=\"response\",xlab=\"Std. leg area\",ylab=\"Male approaches\")\nvisreg(ORN.MOD.Q,xvar=\"ABDOMEN\",by=\"LEG\",breaks=c(-2,0,2),scale=\"response\",xlab=\"Std. abdomen area\",ylab=\"Male approaches\")\n\n# with overlay\nvisreg(ORN.MOD.Q,xvar=\"LEG\",by=\"ABDOMEN\",breaks=c(-2,0,2),scale=\"response\",overlay=TRUE,xlab=\"Std. leg area\",ylab=\"Male approaches\")\nvisreg(ORN.MOD.Q,xvar=\"ABDOMEN\",by=\"LEG\",breaks=c(-2,0,2),scale=\"response\",overlay=TRUE,xlab=\"Std. abdomen area\",ylab=\"Male approaches\")\n\n# interaction still clearer in loglinear space\nvisreg(ORN.MOD.Q,xvar=\"LEG\",by=\"ABDOMEN\",breaks=c(-2,0,2),overlay=TRUE)\nvisreg(ORN.MOD.Q,xvar=\"ABDOMEN\",by=\"LEG\",breaks=c(-2,0,2),overlay=TRUE)\n\n# Or can go \"old-school\" and use predict if you want (?????)\n\nNEWABD<-seq(-3,3,length=100)\nLEGmin2<-rep(-2,100)\nLEG2<-rep(2,100)\n\nNEWLEG<-seq(-3,3,length=100)\nABDmin2<-rep(-2,100)\nABD2<-rep(2,100)\n\n\n# predicted values on log-transformed scale\nPREDSBYLEGABDmin2<-predict(ORN.MOD.Q,newdata=list(LEG=NEWLEG,ABDOMEN=ABDmin2),se.fit=TRUE)\nstr(PREDSBYLEGABDmin2)\nPREDSBYLEGABD2<-predict(ORN.MOD.Q,newdata=list(LEG=NEWLEG,ABDOMEN=ABD2),se.fit=TRUE)\n\nPREDSBYABDLEGmin2<-predict(ORN.MOD.Q,newdata=list(LEG=LEGmin2,ABDOMEN=NEWABD),se.fit=TRUE)\nstr(PREDSBYABDLEGmin2)\nPREDSBYABDLEG2<-predict(ORN.MOD.Q,newdata=list(LEG=LEG2,ABDOMEN=NEWABD),se.fit=TRUE)\n\n# now plot effect of legs\n# plot data first\nplot(ATTR~jitter(LEG),data=DF,col=\"gray\")\n# add fitted line for large abdomens; remember to backtransform fits!\nlines(NEWLEG,exp(PREDSBYLEGABD2$fit))\n# add 95% CIs -- very small so arguably can be omitted\n# lines(NEWLEG,exp(PREDSBYLEGABD2$fit+1.96*PREDSBYLEGABD2$se.fit),lty=3)\n# lines(NEWLEG,exp(PREDSBYLEGABD2$fit-1.96*PREDSBYLEGABD2$se.fit),lty=3)\n\n# add fitted line for small abdomens; remember to backtransform fits!\nlines(NEWLEG,exp(PREDSBYLEGABDmin2$fit),lty=2)\n# add 95% CIs\n# lines(NEWLEG,exp(PREDSBYLEGABDmin2$fit+1.96*PREDSBYLEGABDmin2$se.fit),lty=3)\n# lines(NEWLEG,exp(PREDSBYLEGABDmin2$fit-1.96*PREDSBYLEGABDmin2$se.fit),lty=3)\n\n# now plot effect of abdomens\nplot(ATTR~ABDOMEN,data=DF,col=\"gray\")\n# add fitted line for large abdomes; remember to backtransform fits!\nlines(NEWABD,exp(PREDSBYABDLEG2$fit))\n# add 95% CIs\n# lines(NEWABD,exp(PREDSBYABDLEG2$fit+1.96*PREDSBYABDLEG2$se.fit),lty=3)\n# lines(NEWABD,exp(PREDSBYABDLEG2$fit-1.96*PREDSBYABDLEG2$se.fit),lty=3)\n\n# add fitted line for small abdomens; remember to backtransform fits!\nlines(NEWABD,exp(PREDSBYABDLEGmin2$fit),lty=2)\n# add 95% CIs\n# lines(NEWABD,exp(PREDSBYABDLEGmin2$fit+1.96*PREDSBYABDLEGmin2$se.fit),lty=3)\n# lines(NEWABD,exp(PREDSBYABDLEGmin2$fit-1.96*PREDSBYABDLEGmin2$se.fit),lty=3)\n\n\n\n# now plot effect of abdomens on log\nplot(log(ATTR)~ABDOMEN,data=DF,col=\"gray\",ylab=\"Log-transformed attractiveness\")\n# add fitted line for large abdomens\nlines(NEWABD,PREDSBYABDLEG2$fit)\n# add 95% CIs\n# lines(NEWABD,exp(PREDSBYABDLEG2$fit+1.96*PREDSBYABDLEG2$se.fit),lty=3)\n# lines(NEWABD,exp(PREDSBYABDLEG2$fit-1.96*PREDSBYABDLEG2$se.fit),lty=3)\n\n# add fitted line for small abdomens\nlines(NEWABD,PREDSBYABDLEGmin2$fit,lty=2)\n# add 95% CIs\n# lines(NEWABD,exp(PREDSBYABDLEGmin2$fit+1.96*PREDSBYABDLEGmin2$se.fit),lty=3)\n# lines(NEWABD,exp(PREDSBYABDLEGmin2$fit-1.96*PREDSBYABDLEGmin2$se.fit),lty=3)\n\n",
    "created" : 1449136486537.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1091458473",
    "id" : "2B484D3E",
    "lastKnownWriteTime" : 1448869920,
    "path" : "~/Documents/formations/R - Ecosse/courses/Mod_7_predict/AdvInRpredict.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "type" : "r_source"
}